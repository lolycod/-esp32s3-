# 小月智能家居系统 - 硬件接线图与测试清单

> 文档版本: 1.0
> 更新日期: 2024-12-14
> 适用硬件: ESP32-S3 + MaixCAM

---

## 目录

1. [系统架构概览](#1-系统架构概览)
2. [ESP32-S3 GPIO接口占用表](#2-esp32-s3-gpio接口占用表)
3. [传感器模块接线图](#3-传感器模块接线图)
4. [执行器模块接线图](#4-执行器模块接线图)
5. [MaixCAM配置](#5-maixcam配置)
6. [Web服务器配置](#6-web服务器配置)
7. [完整测试清单](#7-完整测试清单)
8. [故障排查指南](#8-故障排查指南)

---

## 1. 系统架构概览

```
┌─────────────────────────────────────────────────────────────────────┐
│                        小月智能家居系统                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────┐     WebSocket      ┌─────────────┐                │
│  │  ESP32-S3   │ ◄─────────────────► │  Web服务器   │                │
│  │  (下位机)    │    传感器数据/控制   │  (Node.js)  │                │
│  └─────────────┘                    └──────┬──────┘                │
│         │                                  │                        │
│         │ GPIO                             │ HTTP/WS                │
│         ▼                                  ▼                        │
│  ┌─────────────┐                    ┌─────────────┐                │
│  │   传感器     │                    │  Web前端    │                │
│  │   执行器     │                    │  (浏览器)   │                │
│  └─────────────┘                    └─────────────┘                │
│                                            ▲                        │
│  ┌─────────────┐     WebSocket            │                        │
│  │  MaixCAM    │ ─────────────────────────┘                        │
│  │  (视觉识别)  │    图像帧/检测结果                                 │
│  └─────────────┘                                                    │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 2. ESP32-S3 GPIO接口占用表

### 2.1 GPIO占用总览

| GPIO | 功能 | 模块 | 方向 | 备注 |
|:----:|:-----|:-----|:----:|:-----|
| **4** | DHT11数据线 | 温湿度传感器 | I/O | 单总线协议 |
| **5** | MQ-2 TTL输出 | 烟雾传感器 | IN | 数字信号 (高电平=检测到烟雾) |
| **6** | MQ-2 ADC输出 | 烟雾传感器 | IN | ADC1_CH5, 模拟电压 |
| **7** | LDR ADC输出 | 光敏电阻 | IN | ADC1_CH6, 模拟电压 |
| **8** | LDR DO输出 | 光敏电阻 | IN | 数字信号 (可调阈值) |
| **11** | RGB红色通道 | LED指示灯 | OUT | PWM输出 |
| **12** | RGB绿色通道 | LED指示灯 | OUT | PWM输出 |
| **13** | RGB蓝色通道 | LED指示灯 | OUT | PWM输出 |
| **14** | 电机1 IN1 | TB6612 | OUT | 方向控制 |
| **15** | 电机1 IN2 | TB6612 | OUT | 方向控制 |
| **16** | 电机1 PWM | TB6612 | OUT | 速度控制 (5kHz) |
| **17** | 电机2 IN1 | TB6612 (备用) | OUT | 方向控制 |
| **18** | 电机2 IN2 | TB6612 (备用) | OUT | 方向控制 |
| **19** | 电机2 PWM | TB6612 (备用) | OUT | 速度控制 |
| **38** | 舵机信号线 | MG90S舵机 | OUT | PWM 50Hz |
| **48** | WS2812 RGB | 内置LED (已禁用) | OUT | 预留 |

### 2.2 ADC通道映射

| ADC通道 | GPIO | 功能 | 衰减设置 | 测量范围 |
|:-------:|:----:|:-----|:--------:|:--------:|
| ADC1_CH5 | GPIO6 | MQ-2烟雾电压 | 11dB | 0-3.3V |
| ADC1_CH6 | GPIO7 | 光敏电阻电压 | 11dB | 0-3.3V |

### 2.3 LEDC PWM通道分配

| LEDC通道 | Timer | GPIO | 频率 | 功能 |
|:--------:|:-----:|:----:|:----:|:-----|
| CH0 | Timer0 | 11 | 5kHz | RGB红色 |
| CH1 | Timer0 | 12 | 5kHz | RGB绿色 |
| CH2 | Timer0 | 13 | 5kHz | RGB蓝色 |
| CH3 | Timer1 | 38 | 50Hz | 舵机PWM |
| CH4 | Timer2 | 16 | 5kHz | 电机1 PWM |
| CH5 | Timer2 | 19 | 5kHz | 电机2 PWM |

---

## 3. 传感器模块接线图

### 3.1 DHT11 温湿度传感器

```
DHT11模块                ESP32-S3
┌─────────┐
│  VCC    │ ────────────► 3.3V
│  DATA   │ ────────────► GPIO4
│  GND    │ ────────────► GND
└─────────┘
```

**接线说明：**
- VCC: 3.3V或5V供电均可
- DATA: 需要4.7kΩ上拉电阻到VCC（部分模块已内置）
- 采样间隔: 5000ms (最小2000ms)

**技术参数：**
| 参数 | 范围 | 精度 |
|:-----|:----:|:----:|
| 温度 | 0-50°C | ±2°C |
| 湿度 | 20-90% RH | ±5% |

---

### 3.2 MQ-2 烟雾传感器

```
MQ-2模块                 ESP32-S3
┌─────────┐
│  VCC    │ ────────────► 5V (需要5V供电!)
│  GND    │ ────────────► GND
│  DO     │ ────────────► GPIO5 (数字输出)
│  AO     │ ────────────► GPIO6 (模拟输出)
└─────────┘
```

**接线说明：**
- VCC: **必须5V供电**（3.3V供电会导致读数异常）
- DO: 数字输出，可通过模块上的电位器调节阈值
- AO: 模拟输出，电压与烟雾浓度成正比

**技术参数：**
| 参数 | 值 |
|:-----|:---|
| 预热时间 | 20秒以上 |
| 检测气体 | LPG、丙烷、氢气、甲烷、烟雾 |
| 报警阈值 | 代码设置为 1.0V |

---

### 3.3 5516光敏电阻模块

```
光敏电阻模块             ESP32-S3
┌─────────┐
│  VCC    │ ────────────► 3.3V
│  GND    │ ────────────► GND
│  DO     │ ────────────► GPIO8 (数字输出)
│  AO     │ ────────────► GPIO7 (模拟输出)
└─────────┘
```

**接线说明：**
- DO: 数字输出，光照不足时输出高电平
- AO: 模拟输出，电压与光照强度成反比
- 模块上的电位器可调节DO输出的阈值

**技术参数：**
| 参数 | 值 |
|:-----|:---|
| 工作电压 | 3.3-5V |
| 输出信号 | 数字+模拟 |
| 光照范围 | 0-100% (软件换算) |

---

## 4. 执行器模块接线图

### 4.1 RGB LED指示灯（共阳极）

```
RGB LED                  ESP32-S3
┌─────────┐
│  R      │ ────────────► GPIO11 (红色)
│  G      │ ────────────► GPIO12 (绿色)
│  B      │ ────────────► GPIO13 (蓝色)
│  COM    │ ────────────► 3.3V (共阳极)
└─────────┘

如果是共阴极LED，COM接GND
```

**限流电阻：**
- 每个颜色通道串联220Ω-330Ω电阻
- 或使用带限流电阻的LED模块

**PWM控制：**
- 频率: 5kHz
- 占空比: 0-100% (亮度控制)

---

### 4.2 MG90S舵机

```
MG90S舵机                ESP32-S3
┌─────────┐
│  红线(VCC) │ ────────────► 5V (外部电源推荐)
│  棕线(GND) │ ────────────► GND
│  橙线(SIG) │ ────────────► GPIO38
└─────────┘
```

**接线说明：**
- **重要**: 舵机建议使用独立5V电源供电，避免ESP32供电不足
- 信号线直接连接GPIO38即可

**PWM参数：**
| 参数 | 值 |
|:-----|:---|
| PWM频率 | 50Hz (周期20ms) |
| 最小脉宽 | 500μs (0°) |
| 中间脉宽 | 1500μs (90°) |
| 最大脉宽 | 2500μs (180°) |

**WebSocket控制命令：**
```
SERVO_0    → 舵机转到0度
SERVO_90   → 舵机转到90度
SERVO_180  → 舵机转到180度
```

---

### 4.3 TB6612直流电机驱动

```
TB6612模块               ESP32-S3
┌─────────────┐
│  VM (电机电源) │ ────────► 5-12V (外部电源)
│  VCC        │ ────────► 3.3V
│  GND        │ ────────► GND
│  STBY       │ ────────► 3.3V (使能)
│             │
│  AIN1       │ ────────► GPIO14
│  AIN2       │ ────────► GPIO15
│  PWMA       │ ────────► GPIO16
│             │
│  BIN1       │ ────────► GPIO17 (备用电机2)
│  BIN2       │ ────────► GPIO18 (备用电机2)
│  PWMB       │ ────────► GPIO19 (备用电机2)
│             │
│  AO1        │ ────────► 电机A+
│  AO2        │ ────────► 电机A-
│  BO1        │ ────────► 电机B+ (备用)
│  BO2        │ ────────► 电机B- (备用)
└─────────────┘
```

**电机控制真值表：**
| IN1 | IN2 | PWM | 电机状态 |
|:---:|:---:|:---:|:---------|
| 1 | 0 | 占空比 | 正转 |
| 0 | 1 | 占空比 | 反转 |
| 0 | 0 | X | 停止（滑行） |
| 1 | 1 | X | 刹车 |

**WebSocket控制命令：**
```
FAN_ON     → 电机正转 (默认80%速度)
FAN_OFF    → 电机停止
FAN_50     → 电机50%速度
FAN_100    → 电机100%速度
```

---

## 5. MaixCAM配置

### 5.1 网络配置

| 参数 | 值 | 说明 |
|:-----|:---|:-----|
| WebSocket服务器IP | 192.168.31.150 | Web服务器地址 |
| WebSocket端口 | 8080 | 与Web服务器相同 |
| MJPEG流端口 | 8000 | 本地HTTP视频流 |

### 5.2 视觉检测配置

| 参数 | 值 |
|:-----|:---|
| 模型文件 | model_243027.mud |
| 检测类别 | 人类 (class_id=0), 火焰 (class_id=1) |
| 输入分辨率 | 640x480 |
| 检测帧率 | 10 FPS |
| JPEG质量 | 70 |

### 5.3 MaixCAM接线

MaixCAM为独立设备，通过WiFi连接到Web服务器，无需物理接线到ESP32。

**配置文件位置**: `maixcam/main.py` 第21-27行

```python
WEB_SERVER_IP = "192.168.31.150"  # 修改为你的电脑IP
WEB_SERVER_PORT = 8080
FRAME_SEND_INTERVAL = 0.1        # 10 FPS
JPEG_QUALITY = 70
```

---

## 6. Web服务器配置

### 6.1 服务器参数

| 参数 | 值 | 配置文件 |
|:-----|:---|:---------|
| HTTP/WebSocket端口 | 8080 | server.config.js |
| 最大连接数 | 100 | server.config.js |
| 心跳间隔 | 30秒 | server.config.js |
| 消息最大大小 | 1MB | server.config.js |

### 6.2 需要修改的IP地址

**ESP32端** (`main/main.c` 第157行):
```c
.websocket_uri = "ws://192.168.183.121:8080",  // 修改为你的PC IP
```

**MaixCAM端** (`maixcam/main.py` 第21行):
```python
WEB_SERVER_IP = "192.168.31.150"  # 修改为你的PC IP
```

**MJPEG代理** (`web/server/lib/UnifiedServer.js` 第195-196行):
```javascript
const MAIXCAM_IP = '192.168.31.43';      // MaixCAM的IP
const MAIXCAM_MJPEG_PORT = 8000;
```

### 6.3 WiFi配置

**ESP32 WiFi** (`main/main.c` 第134-135行):
```c
.ssid = "123",
.password = "123456abc",
```

---

## 7. 完整测试清单

### 7.1 ESP32传感器测试

| 序号 | 测试项目 | 测试方法 | 预期结果 | 实际结果 | 通过 |
|:----:|:---------|:---------|:---------|:---------|:----:|
| 1 | DHT11温度读取 | 查看串口日志 | 温度值在0-50°C范围内 | | [ ] |
| 2 | DHT11湿度读取 | 查看串口日志 | 湿度值在20-90%范围内 | | [ ] |
| 3 | MQ-2数字输出 | 用打火机靠近传感器 | GPIO5检测到高电平 | | [ ] |
| 4 | MQ-2模拟输出 | 查看串口日志 | ADC读数随烟雾浓度变化 | | [ ] |
| 5 | 光敏电阻数字输出 | 遮挡/照射传感器 | GPIO8电平变化 | | [ ] |
| 6 | 光敏电阻模拟输出 | 查看串口日志 | ADC读数随光照强度变化 | | [ ] |

### 7.2 ESP32执行器测试

| 序号 | 测试项目 | 测试方法 | 预期结果 | 实际结果 | 通过 |
|:----:|:---------|:---------|:---------|:---------|:----:|
| 7 | RGB LED红色 | 发送LED_RED命令 | LED显示红色 | | [ ] |
| 8 | RGB LED绿色 | 发送LED_GREEN命令 | LED显示绿色 | | [ ] |
| 9 | RGB LED蓝色 | 发送LED_BLUE命令 | LED显示蓝色 | | [ ] |
| 10 | RGB LED关闭 | 发送LED_OFF命令 | LED熄灭 | | [ ] |
| 11 | 舵机0度 | 发送SERVO_0命令 | 舵机转到0度位置 | | [ ] |
| 12 | 舵机90度 | 发送SERVO_90命令 | 舵机转到90度位置 | | [ ] |
| 13 | 舵机180度 | 发送SERVO_180命令 | 舵机转到180度位置 | | [ ] |
| 14 | 电机正转 | 发送FAN_ON命令 | 电机正转 | | [ ] |
| 15 | 电机停止 | 发送FAN_OFF命令 | 电机停止 | | [ ] |
| 16 | 电机调速 | 发送FAN_50命令 | 电机50%速度运转 | | [ ] |

### 7.3 通信测试

| 序号 | 测试项目 | 测试方法 | 预期结果 | 实际结果 | 通过 |
|:----:|:---------|:---------|:---------|:---------|:----:|
| 17 | ESP32 WiFi连接 | 查看串口日志 | 显示"WiFi连接成功" | | [ ] |
| 18 | ESP32 WebSocket连接 | 查看串口日志 | 显示WebSocket连接成功 | | [ ] |
| 19 | 传感器数据上传 | 打开Web界面传感器模式 | 实时显示温湿度等数据 | | [ ] |
| 20 | Web控制命令下发 | 在Web界面点击控制按钮 | ESP32执行相应动作 | | [ ] |

### 7.4 MaixCAM测试

| 序号 | 测试项目 | 测试方法 | 预期结果 | 实际结果 | 通过 |
|:----:|:---------|:---------|:---------|:---------|:----:|
| 21 | MaixCAM启动 | 运行main.py | 显示"模型加载成功" | | [ ] |
| 22 | WebSocket连接 | 查看MaixCAM输出 | 显示"WebSocket连接成功" | | [ ] |
| 23 | 人体检测 | 对准人站立 | 检测到人类目标 | | [ ] |
| 24 | 火焰检测 | 对准打火机火焰 | 检测到火焰目标 | | [ ] |
| 25 | 图像传输 | 打开Web视觉检测页面 | 实时显示摄像头画面 | | [ ] |

### 7.5 Web界面测试

| 序号 | 测试项目 | 测试方法 | 预期结果 | 实际结果 | 通过 |
|:----:|:---------|:---------|:---------|:---------|:----:|
| 26 | Web服务器启动 | 运行node server.js | 显示"服务器启动成功" | | [ ] |
| 27 | 访问Web界面 | 浏览器打开localhost:8080 | 显示小月智能家居界面 | | [ ] |
| 28 | AI对话模式 | 点击"AI对话"按钮 | 切换到AI对话界面 | | [ ] |
| 29 | 传感器监控模式 | 点击"传感器监控"按钮 | 显示实时传感器数据和图表 | | [ ] |
| 30 | 控制模式 | 点击"控制模式"按钮 | 显示设备控制面板 | | [ ] |
| 31 | 视觉检测模式 | 点击"视觉检测"按钮 | 显示MaixCAM视频流 | | [ ] |

---

## 8. 故障排查指南

### 8.1 传感器故障

| 故障现象 | 可能原因 | 解决方法 |
|:---------|:---------|:---------|
| DHT11读数为0或无响应 | 接线错误或传感器损坏 | 检查GPIO4接线，更换传感器 |
| MQ-2始终读取0 | 供电不足（需5V） | 确保MQ-2使用5V供电 |
| MQ-2预热后仍无反应 | ADC通道配置错误 | 检查GPIO6是否正确配置为ADC |
| 光敏电阻读数不变 | DO阈值设置不当 | 调节模块上的电位器 |

### 8.2 执行器故障

| 故障现象 | 可能原因 | 解决方法 |
|:---------|:---------|:---------|
| LED不亮 | 限流电阻过大或接线错误 | 检查电阻值和共阳/共阴接法 |
| 舵机抖动 | 供电不足 | 使用独立5V电源供电 |
| 舵机不转 | PWM信号问题 | 检查GPIO38输出，确认LEDC配置 |
| 电机不转 | STBY未使能 | 确保STBY接3.3V |
| 电机只能单向转 | IN1/IN2接线错误 | 检查GPIO14/15接线 |

### 8.3 通信故障

| 故障现象 | 可能原因 | 解决方法 |
|:---------|:---------|:---------|
| WiFi连接失败 | SSID或密码错误 | 检查main.c中的WiFi配置 |
| WebSocket连接失败 | IP地址错误或服务器未启动 | 确认Web服务器已启动，检查IP配置 |
| MaixCAM连接失败 | IP地址配置错误 | 检查main.py中的WEB_SERVER_IP |
| 视频流无法显示 | MJPEG代理配置错误 | 检查UnifiedServer.js中的MaixCAM IP |

### 8.4 常用调试命令

**ESP32串口监控：**
```bash
idf.py monitor
```

**Web服务器启动：**
```bash
cd web/server
node server.js
```

**MaixCAM启动：**
```bash
python3 main.py
```

---

## 附录：完整接线汇总图

```
                              ESP32-S3 开发板
                         ┌─────────────────────┐
                         │                     │
    DHT11 DATA ──────────┤ GPIO4          3V3  ├──── VCC (传感器/LED)
    MQ-2 DO ─────────────┤ GPIO5          GND  ├──── GND (公共地)
    MQ-2 AO ─────────────┤ GPIO6          5V   ├──── VCC (MQ-2/舵机/电机)
    LDR AO ──────────────┤ GPIO7               │
    LDR DO ──────────────┤ GPIO8               │
                         │                     │
    RGB LED R ───────────┤ GPIO11              │
    RGB LED G ───────────┤ GPIO12              │
    RGB LED B ───────────┤ GPIO13              │
                         │                     │
    TB6612 AIN1 ─────────┤ GPIO14              │
    TB6612 AIN2 ─────────┤ GPIO15              │
    TB6612 PWMA ─────────┤ GPIO16              │
    TB6612 BIN1 ─────────┤ GPIO17         USB  ├──── 电脑 (烧录/调试)
    TB6612 BIN2 ─────────┤ GPIO18              │
    TB6612 PWMB ─────────┤ GPIO19              │
                         │                     │
    MG90S Signal ────────┤ GPIO38              │
                         │                     │
                         └─────────────────────┘

    电源供电:
    ├── ESP32: USB 5V 或外部5V
    ├── 传感器(DHT11/LDR): 3.3V
    ├── MQ-2: 5V (必须!)
    ├── 舵机: 5V (建议独立电源)
    └── 电机驱动VM: 5-12V (根据电机规格)
```

---

**文档结束**

如有问题，请检查：
1. 所有GND是否共地
2. 电源电压是否正确
3. GPIO配置是否与代码一致
4. 网络IP地址是否正确配置
